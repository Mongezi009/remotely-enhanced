# Caddyfile for Remotely Enhanced
{
    # Global options
    admin localhost:2019
    log {
        output stdout
        format console
        level INFO
    }
}

# Replace with your domain
{$DOMAIN:remotely.localhost} {
    # Enable automatic HTTPS
    tls internal

    # Logging
    log {
        output file /data/access.log {
            roll_size 10MB
            roll_keep 5
        }
    }

    # Security headers
    header {
        # Enable XSS protection
        X-XSS-Protection "1; mode=block"
        # Prevent content type sniffing
        X-Content-Type-Options "nosniff"
        # Clickjacking protection
        X-Frame-Options "SAMEORIGIN"
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Content Security Policy
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' wss: ws:; font-src 'self' data:; media-src 'self' blob:;"
        
        # Remove server information
        -Server
    }

    # Handle WebSocket connections for SignalR
    @websocket {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    reverse_proxy @websocket remotely-server:5000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Port {server_port}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
    }

    # Handle all other requests
    reverse_proxy remotely-server:5000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Port {server_port}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # Health check
        health_uri /health
        health_interval 10s
        health_timeout 5s
        
        # Load balancing (if scaling)
        lb_policy round_robin
    }

    # Compression
    encode {
        gzip
        zstd
        minimum_length 1024
    }

    # File server for static assets (if needed)
    file_server /assets/* {
        root /var/www/remotely/assets
        precompressed gzip br
    }
}

# Redirect HTTP to HTTPS
http://{$DOMAIN:remotely.localhost} {
    redir https://{host}{uri} permanent
}

# Health check endpoint
:2020 {
    respond /health "OK" 200
}